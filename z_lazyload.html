<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>策略模式图片懒加载</title>
    <style type="text/css">
    * {
        margin: 0;
        padding: 0;
    }
    
    body {
        margin: 0 auto;
    }
    
    .floor {
        width: 960px;
        height: 300px;
        margin: 0 auto;
        padding: 50px;
    }
    
    .img-box {
        float: left;
        width: 160px;
        height: 160px;
        margin: 25px;
        position: relative;
    }
    
    .img-box .img-bg {
        width: 160px;
        height: 160px;
        background: url(http://static02.fn-mart.com/images/feiniu.gif) no-repeat center center;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 99;
    }
    
    .img-box img {
        width: 160px;
        height: 160px;
        position: absolute;
        left: 0;
        top: 0;
    }
    
    .slider {
        width: 210px;
        height: 300px;
        border: 1px solid red;
        overflow: hidden;
    }
    
    .slider ul {
        width: 2000px;
        list-style: none;
        position: relative;
        top: 0;
        left: 0;
    }
    
    .slider ul li {
        float: left;
        width: 210px;
        height: 210px;
    }
    </style>
</head>

<body>
    <div class="floor">1
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2013/1107/201311C070001717/_559079375_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img02.fn-mart.com/C/item/2013/1029/201310C290002555/0_2_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img03.fn-mart.com/C/item/2015/0629/201506C290000277/201506C290000210_462846461_160x160.jpg"></div>
        </div>
    </div>
    <div class="floor">2
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
    </div>
    <div class="floor">3
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
    </div>
    <div class="floor">4
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
    </div>
    <div class="floor">5
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
    </div>
    <div class="floor">6
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
    </div>
    <div class="floor">7
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
    </div>
    <div class="floor">8
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
    </div>
    <div class="floor">9
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
    </div>
    <div class="floor">10
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
        <div class="img-box">
            <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
        </div>
    </div>
    <button id="btn_slider">next</button>
    <div class="slider">
        <ul>
            <li>
                <div class="img-box">1
                    <div class="img-bg" data-src="http://img01.fn-mart.com/C/item/2015/0416/201504C160009937/_056818901_160x160.jpg"></div>
                </div>
            </li>
            <li>
                <div class="img-box">2
                    <div class="img-bg" data-src="http://img02.fn-mart.com/C/item/2013/1029/201310C290002555/0_2_160x160.jpg"></div>
                </div>
            </li>
            <li>
                <div class="img-box">3
                    <div class="img-bg" data-src="http://img04.fn-mart.com/C/item/2014/1111/201411C110000027/_210179529_160x160.jpg"></div>
                </div>
            </li>
            <li>
                <div class="img-box">4
                    <div class="img-bg" data-src="http://img04.fn-mart.com/C/item/2015/0512/201505C120000768/_850603352_160x160.jpg"></div>
                </div>
            </li>
            <li>
                <div class="img-box">5
                    <div class="img-bg" data-src="http://img02.fn-mart.com/C/item/2013/1029/201310C290002555/0_2_160x160.jpg"></div>
                </div>
            </li>
            <li>
                <div class="img-box">6
                    <div class="img-bg" data-src="http://img02.fn-mart.com/C/item/2013/1029/201310C290002555/0_2_160x160.jpg"></div>
                </div>
            </li>
            <li>
                <div class="img-box">7
                    <div class="img-bg" data-src="http://img02.fn-mart.com/C/item/2013/1029/201310C290002555/0_2_160x160.jpg"></div>
                </div>
            </li>
            <li>
                <div class="img-box">8
                    <div class="img-bg" data-src="http://img02.fn-mart.com/C/item/2013/1029/201310C290002555/0_2_160x160.jpg"></div>
                </div>
            </li>
            <li>
                <div class="img-box">9
                    <div class="img-bg" data-src="http://img02.fn-mart.com/C/item/2013/1029/201310C290002555/0_2_160x160.jpg"></div>
                </div>
            </li>
            <li>
                <div class="img-box">10
                    <div class="img-bg" data-src="http://img02.fn-mart.com/C/item/2013/1029/201310C290002555/0_2_160x160.jpg"></div>
                </div>
            </li>
        </ul>
    </div>
    <script type="text/javascript" src="http://libs.baidu.com/jquery/1.11.1/jquery.js"></script>
    <script type="text/javascript">
    /**
     * 策略模式图片懒加载
     * 自定义策略,实现不同区域图片的懒加载
     * @return {[type]}    [description]
     */
    var z_lazyload = (function($) {
        var strategy = {};

        //check返回类型为数组
        //obj是一个类数组对象
        function add_strategy(name, check, obj) {
            if (!strategy[name]) {

                strategy[name] = obj;

                //不同策略需实现检测方法
                strategy[name]['_check'] = check;

            }
        };

        //第一个参数是策略名称,其后是调用方法的参数
        function check(name) {
            var args = arguments.length > 1 ? Array.prototype.slice.call(arguments, 1) : [];
            var tmp = strategy[name] || {};
            var img_arr = tmp['_check'].apply(null, args);

            Array.prototype.forEach.call(img_arr, function(item) {
                var curr = tmp[item];

                if (!curr) {
                    return false;
                }

                $.isArray(curr) ? curr.forEach(loadImg) : loadImg(curr);
                delete strategy[name][item];
            });

        };

        function loadImg(obj) {
            var $this = $(obj);
            $('<img>').attr('src', $this.data('src')).insertBefore($this).on('load', function() {
                $this.fadeOut('slow', function() {
                    $this.remove();
                });
            });
        }

        return {
            add: add_strategy,
            check: check
        }

    }($));
    /*end*/

    //楼层初始化
    $(function() {
        (function() {
            var $floors = $('.floor'),
                floor_height = $floors.height() + 50 * 2;

            var timer = null;

            var obj = Array.prototype.reduce.call($floors, function(prev, next, i) {
                prev[i] = Array.prototype.slice.call($(next).find('.img-bg'));
                return prev;
            }, {});

            z_lazyload && z_lazyload.add('scroll', scrollCheck, obj);

            z_lazyload.check('scroll');

            $(window).on('scroll', scrollLoadImg);

            $(window).on('resize', function() {
                z_lazyload.check('scroll');
            });

            function scrollLoadImg() {
                timer && clearTimeout(timer);
                timer = setTimeout(z_lazyload.check.bind(null, 'scroll'), 200);
            }

            //根据页面可视区计算要显示的楼层
            function scrollCheck() {
                var start = window.scrollY,
                    end = start + $(window).height(),
                    min = Math.floor(start / floor_height),
                    max = Math.floor(end / floor_height),
                    ret = [];

                //去除图片显示位置偏移量,padding,margin,image高度等
                (start - min * floor_height) > (400 - 160 - 50) && min++;
                (end - max * floor_height) < (50 + 25) && max--;

                while (min <= max) {
                    ret.push(min);
                    min++;
                }

                return ret;
            }
        })();

        //轮播初始化
        (function() {
            var $slider = $('.slider'),
                $btn_slider = $('#btn_slider'),
                $ul = $slider.find('ul'),
                obj = {},
                ul_index = 0;

            $ul.find('.img-bg').each(function(i, item) {
                obj[i] = item;
            });

            z_lazyload && z_lazyload.add('slider', sliderCheck, obj);

            z_lazyload.check('slider', ul_index);

            $btn_slider.click(function() {
                $ul.animate({
                    left: $ul.offset().left - 210
                }, z_lazyload.check.bind(null, 'slider', ++ul_index));
            });

            function sliderCheck(index) {
                var ret = [];
                ret.push(index);
                return ret;
            }
        })();
    });
    </script>
    <script type="text/javascript" src="showcode.js"></script>
</body>

</html>
